name: Deploy Service Mesh

on:
  push:
    branches: [main, CLEAN-DEFENSE-BRANCH]
    paths:
      - 'infrastructure/kubernetes/istio/**'
      - '.github/workflows/deploy-service-mesh.yml'
  workflow_dispatch:

env:
  AZURE_SUBSCRIPTION_ID_DEV: ${{ secrets.AZURE_SUBSCRIPTION_ID_DEV }}
  AZURE_SUBSCRIPTION_ID_PROD: ${{ secrets.AZURE_SUBSCRIPTION_ID_PROD }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_ID_DEV: ${{ secrets.AZURE_CLIENT_ID_DEV }}
  AZURE_CLIENT_ID_PROD: ${{ secrets.AZURE_CLIENT_ID_PROD }}
  AZURE_CLIENT_SECRET_DEV: ${{ secrets.AZURE_CLIENT_SECRET_DEV }}
  AZURE_CLIENT_SECRET_PROD: ${{ secrets.AZURE_CLIENT_SECRET_PROD }}
  AKS_CLUSTER_NAME_DEV: pcx42178531-aks
  AKS_CLUSTER_NAME_PROD: policycortex-prod-aks
  AKS_RESOURCE_GROUP_DEV: pcx42178531-rg
  AKS_RESOURCE_GROUP_PROD: policycortex-prod-rg

jobs:
  deploy-istio:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine Environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "client_id=${{ env.AZURE_CLIENT_ID_PROD }}" >> $GITHUB_OUTPUT
            echo "client_secret=${{ env.AZURE_CLIENT_SECRET_PROD }}" >> $GITHUB_OUTPUT
            echo "subscription_id=${{ env.AZURE_SUBSCRIPTION_ID_PROD }}" >> $GITHUB_OUTPUT
            echo "aks_cluster=${{ env.AKS_CLUSTER_NAME_PROD }}" >> $GITHUB_OUTPUT
            echo "aks_rg=${{ env.AKS_RESOURCE_GROUP_PROD }}" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "client_id=${{ env.AZURE_CLIENT_ID_DEV }}" >> $GITHUB_OUTPUT
            echo "client_secret=${{ env.AZURE_CLIENT_SECRET_DEV }}" >> $GITHUB_OUTPUT
            echo "subscription_id=${{ env.AZURE_SUBSCRIPTION_ID_DEV }}" >> $GITHUB_OUTPUT
            echo "aks_cluster=${{ env.AKS_CLUSTER_NAME_DEV }}" >> $GITHUB_OUTPUT
            echo "aks_rg=${{ env.AKS_RESOURCE_GROUP_DEV }}" >> $GITHUB_OUTPUT
          fi

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ steps.env.outputs.client_id }}",
              "clientSecret": "${{ steps.env.outputs.client_secret }}",
              "subscriptionId": "${{ steps.env.outputs.subscription_id }}",
              "tenantId": "${{ env.AZURE_TENANT_ID }}"
            }

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ steps.env.outputs.aks_rg }} \
            --name ${{ steps.env.outputs.aks_cluster }} \
            --overwrite-existing

      - name: Install Istio CLI
        run: |
          curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.20.0 sh -
          sudo mv istio-*/bin/istioctl /usr/local/bin/
          istioctl version --remote=false

      - name: Deploy Istio Service Mesh
        working-directory: ./infrastructure/kubernetes/istio
        run: |
          chmod +x deploy-istio.sh
          ./deploy-istio.sh

      - name: Verify Istio Installation
        run: |
          istioctl verify-install
          kubectl get pods -n istio-system
          kubectl get svc -n istio-system

      - name: Deploy Tenant Applications
        run: |
          # Deploy applications to tenant namespaces
          for tenant in default alpha beta enterprise; do
            echo "Deploying to tenant-$tenant namespace..."
            kubectl apply -f infrastructure/kubernetes/deployments/ -n tenant-$tenant || true
          done

      - name: Configure Istio Telemetry
        run: |
          # Install Prometheus
          kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/addons/prometheus.yaml
          
          # Install Grafana
          kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/addons/grafana.yaml
          
          # Install Kiali
          kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/addons/kiali.yaml

      - name: Output Gateway Information
        run: |
          echo "üåê Istio Ingress Gateway External IP:"
          kubectl get svc istio-ingressgateway -n istio-system -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
          echo ""
          echo "üìä Access URLs:"
          echo "- Kiali: kubectl port-forward svc/kiali -n istio-system 20001:20001"
          echo "- Grafana: kubectl port-forward svc/grafana -n istio-system 3000:3000"
          echo "- Prometheus: kubectl port-forward svc/prometheus -n istio-system 9090:9090"